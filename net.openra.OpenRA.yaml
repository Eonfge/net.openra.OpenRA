app-id: net.openra.OpenRA
runtime: org.freedesktop.Platform
runtime-version: '19.08'
sdk: org.freedesktop.Sdk
command: openra-ra-wrapper
rename-desktop-file: net.openra.OpenRA.openra-ra.desktop
rename-icon: net.openra.OpenRA.openra-ra
finish-args:
  - --socket=x11
  - --share=ipc
  - --socket=wayland
  - --socket=pulseaudio
  - --device=all
  - --share=network
  - --persist=.openra
cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /lib/pkgconfig
  - /share/man
cleanup-commands:
  - >
    find /app/bin -type f -not -name 'openra*' -not -name mono -not -name mono-sgen
    -not -name 'cert-sync*' -not -name python -print0 | xargs -0 rm -rf
  - find /app/lib/mono -mindepth 1 -maxdepth 1 -not -name gac -not -name 4.5 -print0 | xargs -0 rm -rf
  - >
    find /app/lib/mono/gac -mindepth 1 -maxdepth 1 -not -name System -not -name System.Core
    -not -name System.Xml -not -name System.Configuration -not -name I18N -not -name I18N.CJK
    -not -name I18N.MidEast -not -name I18N.Other -not -name I18N.Rare -not -name I18N.West
    -not -name Accessibility -not -name Mono.Cairo -not -name Mono.Posix -not -name Mono.CSharp
    -not -name System.Drawing -not -name System.Numerics -not -name Mono.Security -print0 | xargs -0 rm -rf
  - find /app/lib/mono -type f -name '*.exe' -not -name cert-sync.exe -print0 | xargs -0 rm -rf
modules:
  - name: libgdiplus0
    sources:
      - type: archive
        url: https://download.mono-project.com/sources/libgdiplus/libgdiplus0-6.0.5.tar.gz
        sha256: b81e4e5cc3e4831b2945de08bef26eb1bdcd795aeaf8f971b221c51213a025ef

  - name: python
    buildsystem: simple
    build-commands:
      - install -d /app/bin
      - ln -s /usr/bin/python3 /app/bin/python

  - name: mono
    sources:
      - type: archive
        url: https://download.mono-project.com/sources/mono/mono-6.8.0.123.tar.xz
        sha256: e2e42d36e19f083fc0d82f6c02f7db80611d69767112af353df2f279744a2ac5
    config-opts:
      - --disable-dependency-tracking
      - --without-mcs-docs
    build-options:
      arch:
        arm:
          no-debuginfo: true  # Bug in strip
    cleanup:
      - '*.exe.*'
      - '*.pdb'
      - '*.xsd'
      - /lib/mono/4.5/Facades
      - /lib/mono/4.5/MSBuild
      - /lib/mono-source-libs
      - /share

  - name: msbuild
    sources:
      - type: file
        url: http://download.mono-project.com/repo/ubuntu/pool/main/m/msbuild/msbuild_16.5+xamarinxplat.2020.02.20.11.54-0xamarin2+debian10b1_all.deb
        sha256: 84bb493a82ba62f634c247b448d0159f4a6e528f063ad01f0e8a981ec392cc6c
    cleanup:
      - '*'
    buildsystem: simple
    build-commands:
      - ar x msbuild_*.deb
      - tar xf data.tar.xz
      - sed -e 's|/usr/|/app/|g' -i usr/bin/msbuild
      - cp -a usr/. /app

  - shared-modules/lua5.1/lua-5.1.5.json

  - name: OpenRA
    sources:
      - type: archive
        strip-components: 0
        url: https://github.com/OpenRA/OpenRA/releases/download/playtest-20200426/OpenRA-playtest-20200426-source.tar.bz2
        sha256: ef8ad8fe5426af7a70c5f47d96e8d3bf5bca0c73e61803f5298f15619f7a44be
      - type: shell
        commands:
          - mkdir LocalNugetPackages thirdparty/download
      - type: file
        path: nuget.config
      - type: file
        url: https://nuget.org/api/v2/package/StyleCop.Analyzers/1.1.118
        dest-filename: LocalNugetPackages/stylecop.analyzers.1.1.118.nupkg
        sha256: 0a30b57f9cf4b0fd7917a15e5ea2033ad64b1ea8239904f3a6c22b464c574442
      - type: file
        url: https://nuget.org/api/v2/package/SharpZipLib/1.1.0
        dest-filename: thirdparty/download/SharpZipLib.zip
        sha256: 0f4bb6666a67fde963d90f4a96fd68eb1d098ef55a936d6e712cea74d4b798ca
      - type: file
        url: https://nuget.org/api/v2/package/NUnit/3.0.1
        dest-filename: thirdparty/download/NUnit.zip
        sha256: eb0b156b44142622d7cd573073d6dc925f8529f2860637325f5af85f94db423c
      - type: file
        url: https://nuget.org/api/v2/package/NUnit.Console/3.0.1
        dest-filename: thirdparty/download/NUnit.Console.zip
        sha256: 164ce9124d769ac994a79234e59ce51a21be5089e86210666abfef0791ade07f
      - type: file
        url: https://nuget.org/api/v2/package/Open.Nat/2.1.0
        dest-filename: thirdparty/download/Open.Nat.zip
        sha256: c532dee1478b4a7e28aa4797a5efc3f829a6bd0cc0af646aac001ce183f0e3e2
      - type: file
        url: https://nuget.org/api/v2/package/FuzzyLogicLibrary/1.2.0
        dest-filename: thirdparty/download/FuzzyLogicLibrary.zip
        sha256: ca8caf33637ae661dfdd5797589f034950d2fcb4f7192ee858830f6e2525df3f
      - type: file
        url: https://github.com/OpenRA/SDL2-CS/releases/download/20190907/SDL2-CS.dll
        dest-filename: thirdparty/download/SDL2-CS.dll
        sha256: b06c14a771d14cb37210f476dfd973d4e7d80d97f90566bd5bc78996ade4f7a0
      - type: file
        url: https://github.com/OpenRA/SDL2-CS/releases/download/20190907/SDL2-CS.dll.config
        dest-filename: thirdparty/download/SDL2-CS.dll.config
        sha256: 7d75ef450e1ceb3f61e77a0513b034a5bc2e754065182bc1bc9134ac664da6bd
      - type: file
        url: https://github.com/OpenRA/OpenAL-CS/releases/download/20200316/OpenAL-CS.dll
        dest-filename: thirdparty/download/OpenAL-CS.dll
        sha256: 4cc20a160107748a8e13dfc5e29f9daacf2675e4b302e066bfbe4a1be0596015
      - type: file
        url: https://github.com/OpenRA/OpenAL-CS/releases/download/20200316/OpenAL-CS.dll.config
        dest-filename: thirdparty/download/OpenAL-CS.dll.config
        sha256: b443d4546c18d2e4a856fdfbd14b11f31a7045f1991f175a357e2c4c2feb4c06
      - type: file
        url: https://github.com/OpenRA/Eluant/releases/download/20160124/Eluant.dll
        dest-filename: thirdparty/download/Eluant.dll
        sha256: 218c4ea5424b44d746b5343563123beebc652fd9731967dfd49fed071b58df31
      - type: file
        url: https://nuget.org/api/v2/package/rix0rrr.BeaconLib/1.0.1
        dest-filename: thirdparty/download/rix0rrr.BeaconLib.zip
        sha256: ed4d44f176af53a2fcb31b35def9a5af4cd42bb3639bc2c458f843d991f074ec
      - type: file
        # Source: http://download.ip2location.com/lite/IP2LOCATION-LITE-DB1.IPV6.BIN.ZIP
        path: IP2LOCATION-LITE-DB1-2020-05-28.IPV6.BIN.ZIP
        dest-filename: IP2LOCATION-LITE-DB1.IPV6.BIN.ZIP
      - type: script
        commands:
          - "# NOP"
        dest-filename: fetch-geoip.sh
    buildsystem: simple
    build-commands:
      - make
      - make prefix=/app install
      - make prefix=/app install-linux-shortcuts
      - make prefix=/app install-linux-mime

  - name: cert-sync-wrapper
    buildsystem: simple
    sources:
      - type: script
        commands:
          - cert-sync --user --quiet /etc/ssl/certs/ca-certificates.crt
          - exec "${0/%-wrapper/}" "$@"
        dest-filename: cert-sync-wrapper
    build-commands:
      - install -Dm0755 -t /app/bin cert-sync-wrapper
      - for target in openra-{ra,cnc,d2k}{,-server}; do ln -s cert-sync-wrapper "/app/bin/${target}-wrapper"; done
      - sed -i 's/^Exec=openra-[^ ]*/\0-wrapper/' /app/share/applications/openra-{ra,cnc,d2k}.desktop
    run-tests: false  # Bug: https://github.com/flatpak/flatpak-builder/issues/229
    test-commands:
      - |
        for f in /app/share/applications/*.desktop
        do
          wrapper_cmd="$(grep -o '^Exec=[^ ]*-wrapper\( \|$\)' "$f" | cut -d= -f2- | tr -d ' ')"
          test -f "/app/bin/${wrapper_cmd}" -a -x "/app/bin/${wrapper_cmd}" || exit 1
          test "$f" = "/app/share/applications/${wrapper_cmd%-wrapper}.desktop" || exit 1
        done

  - name: export
    buildsystem: simple
    sources:
      - type: file
        path: net.openra.OpenRA.appdata.xml
    build-commands:
      - sed -i 's/Icon=openra/Icon=net.openra.OpenRA.openra/' /app/share/applications/openra-{ra,cnc,d2k}.desktop
      - |
        for f in /app/share/icons/hicolor/*/apps/openra-{ra,cnc,d2k}.* \
                 /app/share/applications/openra-{ra,cnc,d2k}.desktop \
                 /app/share/mime/packages/openra-{ra,cnc,d2k}.xml
        do
          mv "$f" "${f/openra/net.openra.OpenRA.openra}" || exit 1
        done
      - install -Dm0644 -t /app/share/metainfo net.openra.OpenRA.appdata.xml
